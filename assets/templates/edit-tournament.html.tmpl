<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>{{ if .IsNew }}Create{{ else }}Edit{{ end }} Tournament</title>
    <link rel="stylesheet" href="/style/{{ .SiteConfig.Theme }}/css">
</head>

<body>
    {{ template "user-bar" . }}
    <div class="container">
        <div class="admin-bar">
            <a href="/">&lt; Back to Home</a>
            {{ if not .IsNew }}
            <a href="/t/{{ .Tournament.EventID }}">View Tournament</a>
            {{ end }}
        </div>

        <h1>{{ if .IsNew }}Create{{ else }}Edit{{ end }}
            Tournament
            {{ if not .IsNew }}{{ .Tournament.EventID }}{{ end }}</h1>

        {{ if not .IsNew }}
        <div class="info-box">
            <p>Be sure to press Save.</p>
            <p>
                Edits to a running tournament may be surprising. Changes to a live tournament will
                lock out this form, and you will have to hit reload (due to conflicting writes).
            </p>
        </div>
        {{ end }}

        <form method="POST">
            {{ if not .IsNew }}
            <input type="hidden" name="Version" value="{{ .Tournament.Version }}">
            {{ end }}
            <input type="hidden" id="BuyIns" name="BuyIns" value="{{ .Tournament.State.BuyIns }}">
            <input type="hidden" id="AddOns" name="AddOns" value="{{ .Tournament.State.AddOns }}">

            <section class="form-section">
                <h2> Tournament Details </h2>
                <div class="form-group">
                    <label for="EventName">Name</label>
                    <input type="text" id="EventName" name="EventName" class="field-text" maxlength="30" required value="{{ .Tournament.EventName }}">
                </div>

                <div class="form-group">
                    <label for="Description">Description</label>
                    <input type="text" id="Description" name="Description" class="field-text" maxlength="50" value="{{ .Tournament.Description }}">
                </div>

                <div class="form-group">
                    <label for="FooterPlugsID">Footer Plugs</label>
                    <select id="FooterPlugsID" name="FooterPlugsID" required>
                        {{ range .FooterSets }}
                        <option value="{{ .FooterPlugsID }}" {{ if eq .FooterPlugsID $.Tournament.FooterPlugsID }} selected{{ end }}>{{ .Name }}</option>
                        {{ end }}
                    </select>
                </div>

                <div class="form-group">
                    <label for="NextLevelSoundID">Next Level Sound</label>
                    <div class="sound-select-container">
                        <select id="NextLevelSoundID" name="NextLevelSoundID">
                            <option value="-1" data-path="">Silent</option>
                            {{ range .Sounds }}
                            <option value="{{ .ID }}" data-path="{{ .Path }}"
                                {{- if eq .ID $.Tournament.NextLevelSoundID }} selected {{ end -}}>
                            {{ .Name }} ({{ .Description }})
                            </option>
                            {{ end }}
                        </select>
                        <button type="button" id="PlaySoundBtn" class="sound-play-btn" title="Play selected sound">▶</button>
                    </div>
                </div>
            </section>

            <section class="form-section">
                <h2> {{ if .IsNew }}Structure{{ else }}Change Structure{{ end }} </h2>
                                {{ if .IsNew }}
                <input type="hidden" id="ChangeStructure" name="ChangeStructure" value="on">
                {{ else }}
                <div>
                    <input type="checkbox" id="ChangeStructure" name="ChangeStructure"
                        onchange="toggleStructureSelect()" style="display: inline; margin: 0; width: auto;">
                    <label for="ChangeStructure" style="display: inline; margin: 0;">
                        Change Structure (+ re-start)
                    </label>
                </div>
                {{ end }}
                <select id="StructureID" name="StructureID" {{ if .IsNew }}required{{ else }}disabled{{ end }} onchange="loadStructureChipValues()">
                    {{ range $.Structures }}
                    <option value="{{ .ID }}" 
                        data-chips-per-buyin="{{ .ChipsPerBuyIn }}" 
                        data-chips-per-addon="{{ .ChipsPerAddOn }}"
                        {{ if eq .ID $.Tournament.FromStructureID }}selected{{ end }}>
                        {{ .Name }}
                    </option>
                    {{ end }}
                </select>
            </section>

            <section class="form-section">
                <h2> Chip Setup </h2>

                <div class="form-group">
                    <table class="calc-table" style="border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="text-align: left;">Type</th>
                                <th style="text-align: left;">Amount</th>
                                <th> </th>
                                <th style="text-align: left;">&numero;</th>
                                <th> </th>
                                <th style="text-align: left;">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Buy-Ins:</td>
                                <td>
                                    <input type="text" id="ChipsPerBuyIn" name="ChipsPerBuyIn"
                                        class="field-medium editable" maxlength="30" pattern="[0-9,]+"
                                        placeholder="T/Buy-in" value="{{ .Tournament.Structure.ChipsPerBuyIn }}">
                                </td>
                                <td> × </td>
                                <td>
                                    <input type="text" id="ChipSetupBuyIns" class="field-small editable" maxlength="6"
                                        pattern="[0-9,]+" placeholder="Count" value="{{ .Tournament.State.BuyIns }}">
                                </td>
                                <td> = </td>
                                <td>
                                    <input type="text" id="ChipsBuyInSubtotal" class="field-large uneditable" readonly>
                                </td>
                            </tr>
                            <tr>
                                <td>Add-Ons:</td>
                                <td>
                                    <input type="text" id="ChipsPerAddOn" name="ChipsPerAddOn"
                                        class="field-medium editable" maxlength="30" pattern="[0-9,]+"
                                        placeholder="T/Add-on" value="{{ .Tournament.Structure.ChipsPerAddOn }}"> </td>
                                <td> × </td>
                                <td>
                                    <input type="text" id="ChipSetupAddOns" class="field-small editable" maxlength="6"
                                        pattern="[0-9,]+" placeholder="Count" value="{{ .Tournament.State.AddOns }}"> 
                                </td>
                                <td> = </td>
                                <td>
                                    <input type="text" id="ChipsAddOnSubtotal" class="field-large uneditable" readonly>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="5" style="text-align: right; font-weight: bold;">Total:</td>
                                <td>
                                    <input type="text" id="ChipsTotal" class="field-large uneditable" readonly
                                        style="font-weight: bold;">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="form-group">
                    <label for="TotalChipsOverride">Total Chips Override</label>
                    <input type="text" id="TotalChipsOverride" name="TotalChipsOverride" class="field-large"
                        maxlength="30" pattern="[0-9,]+" placeholder="0 to auto-compute" value="{{ .Tournament.State.TotalChipsOverride }}">
                    <small>Leave at 0 to use calculated value above</small>
                </div>
            </section>

            <section class="form-section">
                <h2> Prize Pool </h2>

                <div class="form-group">
                    <table class="calc-table" style="border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="text-align: left;">Type</th>
                                <th style="text-align: left;">Amount</th>
                                <th> </th>
                                <th style="text-align: left;">&numero;</th>
                                <th> </th>
                                <th style="text-align: left;">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Buy-Ins:</td>
                                <td>
                                    <input type="text" id="PrizePoolPerBuyIn" name="PrizePoolPerBuyIn"
                                        class="field-medium editable" maxlength="7" pattern="[0-9,]+"
                                        placeholder="$/Buy-in" value="{{ .Tournament.PrizePoolPerBuyIn }}"> 
                                <td> × </td>
                                <td>
                                    <input type="text" id="PrizePoolBuyIns" class="field-small editable" maxlength="6"
                                        pattern="[0-9,]+" placeholder="Count" value="{{ .Tournament.State.BuyIns }}">
                                <td> = </td>
                                <td>
                                    <input type="text" id="PrizePoolBuyInSubtotal" class="field-large uneditable"
                                        readonly>
                                </td>
                            </tr>
                            <tr>
                                <td>Add-Ons:</td>
                                <td>
                                    <input type="text" id="PrizePoolPerAddOn" name="PrizePoolPerAddOn"
                                        class="field-medium editable" maxlength="7" pattern="[0-9,]+"
                                        placeholder="$/Add-on" value="{{ .Tournament.PrizePoolPerAddOn }}">
                                </td>
                                <td> × </td>
                                <td>
                                    <input type="text" id="PrizePoolAddOns" class="field-small editable" maxlength="6"
                                        pattern="[0-9,]+" placeholder="Count" value="{{ .Tournament.State.AddOns }}">
                                </td>
                                <td> = </td>
                                <td>
                                    <input type="text" id="PrizePoolAddOnSubtotal" class="field-large uneditable"
                                        readonly>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="5" style="text-align: right;">Contributions:</td>
                                <td>
                                    <input type="text" id="PrizePoolSubtotal" class="field-large uneditable" readonly>
                                </td>
                            </tr>
                            <tr>
                                <td>Saves:</td>
                                <td>
                                    <input type="text" id="AmountPerSave" name="AmountPerSave"
                                        class="field-medium editable" maxlength="30" pattern="[0-9,]+"
                                        placeholder="$/Save" value="{{ .Tournament.State.AmountPerSave }}"> </td>
                                <td> × </td>
                                <td>
                                    <input type="text" id="Saves" name="NumberOfSaves" class="field-small editable"
                                        maxlength="6" pattern="[0-9,]+" placeholder="Count"
                                        value="{{ .Tournament.State.Saves }}"> </td>
                                <td> = </td>
                                <td>
                                    <input type="text" id="PrizePoolSavesSubtotal" class="field-large uneditable"
                                        readonly>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="5" style="text-align: right; font-weight: bold;">Total:</td>
                                <td>
                                    <input type="text" id="PrizePoolTotal" class="field-large uneditable" readonly>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="form-group">
                    <label title="Set this to override the automatic computation of the prize pool."
                        for="TotalPrizePoolOverride">Total Prize Pool Override</label>
                    <input type="text" id="TotalPrizePoolOverride" name="TotalPrizePoolOverride" class="field-large"
                        maxlength="30" pattern="[0-9,]+" placeholder="0 to auto-compute" value="{{ .Tournament.State.TotalPrizePoolOverride }}">
                    <small>Leave at 0 to use calculated value above</small>
                </div>

                <div class="form-group">
                    <label for="PrizePoolMode">Prize Pool Mode</label>
                    <select id="PrizePoolMode" name="PrizePoolMode" onchange="togglePrizePoolMode()">
                        <option value="manual" {{ if not .Tournament.State.AutoComputePrizePool }}selected{{ end }}>
                            Manual Message
                        </option>
                        <option value="calculated" {{ if .Tournament.State.AutoComputePrizePool }}selected{{ end }}>
                            Calculated
                            Prize
                            Pool</option>
                    </select>
                </div>

                <div class="form-group" id="PaytableGroup"
                    style="display: {{ if .Tournament.State.AutoComputePrizePool -}} block {{- else -}} none {{- end -}};">
                    <label for="PaytableID">Paytable</label>
                    <select id="PaytableID" name="PaytableID" onchange="maybeRecalcPrizePool()">
                        {{ range $.Paytables }}
                        <option value="{{ .ID }}" {{ if eq .ID $.Tournament.PaytableID }}selected{{ end }}>{{ .Name }}
                        </option>
                        {{ end }}
                    </select>
                </div>

                <div class="form-group">
                    <label title="Prize pool displayed on right rail of tourney view page." for="PrizePool">Prize
                        Pool</label>
                    <small id="PrizePoolHelp">{{ if .Tournament.State.AutoComputePrizePool
                        }}Automatically calculated
                        based on
                        buy-ins,
                        add-ons, and selected paytable{{ else }}Free-form text. No HTML tags.{{ end }}</small>
                    <textarea id="PrizePool" name="PrizePool" rows="12" cols="20" style="width: auto;" {{ if .Tournament.State.AutoComputePrizePool }}readonly{{ end
                        }}>{{ .Tournament.State.PrizePool }}</textarea>
                </div>
            </section>

            <section class="form-section">
                <h2> Tournament State </h2>
                {{ if not .IsNew }}
                <small>
                    Note the tournament may have changed out from under you
                    if the clock is already running. These are easier to
                    edit from the tournament view page, but not as precise.
                </small>
                {{ end }}
                <div class="form-group">
                    <label for="CurrentPlayers">Current Players</label>
                    <input type="text" id="CurrentPlayers" name="CurrentPlayers" class="field-small" maxlength="6"
                        pattern="[0-9,]+" value="{{ .Tournament.State.CurrentPlayers }}">
                </div>

                {{ if not .IsNew }}
                <div class="form-group">
                    <label for="CurrentLevel">Current Level (changes will re-start level)</label>
                    <select id="CurrentLevel" name="CurrentLevel">
                        {{ range $index, $level := .Tournament.Structure.Levels }}
                        {{ $isCurrent := eq $index $.Tournament.State.CurrentLevelNumber }}
                        <option value="{{ $index }}" {{ if $isCurrent}}selected{{ end }}>
                            {{ $level.Banner }} &mdash; {{ $level.Description }}
                            {{ if $level.IsBreak }} [BREAK]{{ end }}
                            {{ if $isCurrent }}*{{end}}
                        </option>
                        {{ end }}
                    </select>
                </div>
                {{ end }}

                {{ if not .IsNew }}
                <div class="form-group">
                    <label for="ClockState">Clock State</label>
                    <select id="ClockState" name="ClockState">
                        <option value="paused" {{ if not .Tournament.State.IsClockRunning }}selected{{ end }}>Clock
                            Paused</option>
                        <option value="running" {{ if .Tournament.State.IsClockRunning }}selected{{ end }}>Clock Running
                        </option>
                    </select>
                </div>
                {{ end }}

                {{ if not .IsNew }}
                <div class="form-group">
                    <label for="TimeRemaining">Time Remaining in Level (MM:SS or HH:MM:SS)</label>
                    <input type="text" id="TimeRemaining" name="TimeRemaining" class="field-medium" maxlength="8"
                        pattern="[0-9:]+" title="time remaining in level -- leave blank for no change"
                        placeholder="HH:MM:SS" value="">
                </div>
                {{ end }}
            </section>

            <script>
                // Utility function to parse number inputs that may contain commas
                function parseNumber(value) {
                    if (!value) return 0;
                    return parseInt(value.toString().replace(/,/g, '')) || 0;
                }

                // Utility function to format numbers with commas
                function commaize(num) {
                    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                }

                // Sync buy-ins and add-ons across all three sections
                function syncFields() {
                    const buyInsFields = ['ChipSetupBuyIns', 'PrizePoolBuyIns', 'BuyIns'];
                    const addOnsFields = ['ChipSetupAddOns', 'PrizePoolAddOns', 'AddOns'];

                    // Setup sync for buy-ins
                    buyInsFields.forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        if (field) {
                            field.addEventListener('input', function (e) {
                                const value = e.target.value;
                                buyInsFields.forEach(otherId => {
                                    if (otherId !== fieldId) {
                                        const otherField = document.getElementById(otherId);
                                        if (otherField) {
                                            otherField.value = value;
                                        }
                                    }
                                });
                                calculateChips();
                                calculatePrizePoolAmount();
                            });
                        }
                    });

                    // Setup sync for add-ons
                    addOnsFields.forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        if (field) {
                            field.addEventListener('input', function (e) {
                                const value = e.target.value;
                                addOnsFields.forEach(otherId => {
                                    if (otherId !== fieldId) {
                                        const otherField = document.getElementById(otherId);
                                        if (otherField) {
                                            otherField.value = value;
                                        }
                                    }
                                });
                                calculateChips();
                                calculatePrizePoolAmount();
                            });
                        }
                    });
                }

                function nff(field) { /* number from field */
                    return parseNumber(document.getElementById(field).value) || 0;
                }

                function snf(field, value) { /* set number to field */
                    document.getElementById(field).value = commaize(value);
                }

                // Calculate and display total chips in play
                function calculateChips() {
                    const buyInChips = nff('BuyIns') * nff('ChipsPerBuyIn');
                    const addOnChips = nff('AddOns') * nff('ChipsPerAddOn');

                    snf('ChipsBuyInSubtotal', buyInChips);
                    snf('ChipsAddOnSubtotal', addOnChips);
                    snf('ChipsTotal', buyInChips + addOnChips);
                }

                function calculatePrizePoolAmount() {
                    const buyInAmount = nff('PrizePoolBuyIns') * nff('PrizePoolPerBuyIn');
                    const addOnAmount = nff('PrizePoolAddOns') * nff('PrizePoolPerAddOn');
                    const subtotal = buyInAmount + addOnAmount;
                    const savesAmount = nff('Saves') * nff('AmountPerSave');
                    const total = subtotal - savesAmount;

                    snf('PrizePoolBuyInSubtotal', buyInAmount);
                    snf('PrizePoolAddOnSubtotal', addOnAmount);
                    snf('PrizePoolSubtotal', subtotal);
                    snf('PrizePoolSavesSubtotal', savesAmount);
                    snf('PrizePoolTotal', total);

                    maybeRecalcPrizePool();
                }

                {{ if not .IsNew }}
                function toggleStructureSelect() {
                    const checkbox = document.getElementById('ChangeStructure');
                    const select = document.getElementById('StructureID');
                    select.disabled = !checkbox.checked;
                    if (!checkbox.checked) {
                        select.removeAttribute('required');
                    } else {
                        select.setAttribute('required', 'required');
                    }
                }
                {{ end }}

                function loadStructureChipValues() {
                    const select = document.getElementById('StructureID');
                    const selectedOption = select.options[select.selectedIndex];
                    
                    const chipsPerBuyIn = selectedOption.getAttribute('data-chips-per-buyin') || '0';
                    const chipsPerAddOn = selectedOption.getAttribute('data-chips-per-addon') || '0';
                    
                    document.getElementById('ChipsPerBuyIn').value = commaize(parseInt(chipsPerBuyIn));
                    document.getElementById('ChipsPerAddOn').value = commaize(parseInt(chipsPerAddOn));
                    
                    // Recalculate totals
                    calculateChips();
                }

                function togglePrizePoolMode() {
                    const mode = document.getElementById('PrizePoolMode').value;
                    const paytableGroup = document.getElementById('PaytableGroup');
                    const prizePoolTextarea = document.getElementById('PrizePool');
                    const helpText = document.getElementById('PrizePoolHelp');

                    if (mode === 'calculated') {
                        paytableGroup.style.display = 'block';
                        prizePoolTextarea.readOnly = true;
                        helpText.textContent = 'Automatically calculated based on buy-ins, add-ons, and selected paytable';
                        maybeRecalcPrizePool();
                    } else {
                        paytableGroup.style.display = 'none';
                        prizePoolTextarea.readOnly = false;
                        helpText.textContent = 'Free-form text (no HTML).';
                    }
                }

                async function maybeRecalcPrizePool() {
                    const mode = document.getElementById('PrizePoolMode').value;
                    if (mode !== 'calculated') {
                        // maybe not.
                        return;
                    }

                    const paytableId = nff('PaytableID');
                    const buyIns = nff('BuyIns');
                    const addOns = nff('AddOns');
                    const saves = nff('Saves');
                    const amountPerSave = nff('AmountPerSave');
                    const prizePoolPerBuyIn = nff('PrizePoolPerBuyIn');
                    const prizePoolPerAddOn = nff('PrizePoolPerAddOn');
                    const totalPrizePoolOverride = nff('TotalPrizePoolOverride');

                    if (buyIns === 0) {
                        document.getElementById('PrizePool').value = 'No buy-ins, so no prizes.';
                        return;
                    }
                    if (prizePoolPerBuyIn === 0) {
                        document.getElementById('PrizePool').value = 'No prize pool per buy-in, so no prizes.';
                        return;
                    }

                    try {
                        const response = await fetch('/api/prizePoolCalculator', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                paytableId,
                                buyIns,
                                addOns,
                                saves,
                                amountPerSave,
                                prizePoolPerBuyIn,
                                prizePoolPerAddOn,
                                totalPrizePoolOverride
                            })
                        });

                        if (!response.ok) {
                            throw new Error('Failed to calculate prize pool');
                        }

                        const data = await response.json();
                        document.getElementById('PrizePool').value = data.prizePoolText;
                    } catch (error) {
                        console.error('Error calculating prize pool:', error);
                        document.getElementById('PrizePool').value = 'Error calculating prize pool';
                    }
                }

                // Sound preview functionality
                let currentAudio = null;

                function playSelectedSound() {
                    const select = document.getElementById('NextLevelSoundID');
                    const selectedOption = select.options[select.selectedIndex];
                    const soundPath = selectedOption.getAttribute('data-path');
                    
                    // Stop any currently playing sound
                    if (currentAudio) {
                        currentAudio.pause();
                        currentAudio = null;
                    }

                    // Don't play if silent is selected or no path
                    if (!soundPath || soundPath === '') {
                        return;
                    }

                    // Create and play new audio
                    currentAudio = new Audio(soundPath);
                    currentAudio.play().catch(error => {
                        console.error('Error playing sound:', error);
                        alert('Failed to play sound: ' + error.message);
                    });
                }

                // Add event listeners for recalculation on field changes
                document.addEventListener('DOMContentLoaded', function () {
                    // Sync buy-ins and add-ons fields first
                    syncFields();

                    ['ChipsPerBuyIn', 'ChipsPerAddOn', 'ChipSetupBuyIns', 'ChipSetupAddOns'].forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        if (field) {
                            field.addEventListener('input', calculateChips);
                        }
                    });

                    // Watch prize pool amount fields - add listeners to all fields that affect prize pool calculation
                    ['PrizePoolPerBuyIn', 'PrizePoolPerAddOn', 'PrizePoolBuyIns', 'PrizePoolAddOns', 'Saves', 'AmountPerSave'].forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        field.addEventListener('input', calculatePrizePoolAmount);
                    });

                    ['TotalPrizePoolOverride'].forEach(field => addEventListener('input', maybeRecalcPrizePool));

                    // Initialize calculations on load
                    calculateChips();
                    calculatePrizePoolAmount();

                    // Set up sound play button
                    const playBtn = document.getElementById('PlaySoundBtn');
                    if (playBtn) {
                        playBtn.addEventListener('click', playSelectedSound);
                    }
                });
            </script>

            <div class="actions">
                {{ if not .IsOperator }}
                <p>You can look but you can't touch</p>
                {{ else if .IsNew }}
                <button type="submit">Create Tournament</button>
                <button type="reset">Reset</button>
                {{ else }}
                <button type="submit">Save Changes</button>
                <button type="reset">Reset to Saved Values</button>
                {{ end }}
            </div>

        </form>

        {{ if .Flash }}<div class="flash">{{ .Flash }}</div>{{ end }}
    </div>
</body>

</html>
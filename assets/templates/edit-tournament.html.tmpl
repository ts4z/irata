<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>{{ if .IsNew }}Create{{ else }}Edit{{ end }} Tournament</title>
    <link rel="stylesheet" href="/fs/{{ .SiteConfig.Theme }}-style.css">
</head>

<body>
    <div class="container">
        <div class="admin-bar">
            <a href="/">&lt; Back to Home</a>
            {{ if not .IsNew }}
            <a href="/t/{{ .Tournament.EventID }}">View Tournament</a>
            {{ end }}
        </div>

        <h1>{{ if .IsNew }}CREATE TOURNAMENT{{ else }}EDIT EVENT {{ .Tournament.EventID }}{{ end }}</h1>

        {{ if not .IsNew }}
        <div class="info-box">
            <p>Be sure to press Save.</p>
            <p>
                Edits to a live tournament will behave weirdly. Any changes to a live tournament will
                lock out this form, and you will have to hit reload before you can make additional edits.
            </p>
        </div>
        {{ end }}

        <form method="POST">
            {{ if not .IsNew }}
            <input type="hidden" name="Version" value="{{ .Tournament.Version }}">
            {{ end }}

            <div class="form-section">
                <h2> Event Details </h2>
                <div class="form-group">
                    <label for="EventName">Event Name</label>
                    <input type="text" id="EventName" name="EventName" maxlength="30" required{{ if not .IsNew }} value="{{ .Tournament.EventName }}"{{ end }}>
                </div>

                <div class="form-group">
                    <label for="Handle">Handle</label>
                    <input type="text" id="Handle" name="Handle" maxlength="30" required{{ if not .IsNew }} value="{{ .Tournament.Handle }}"{{ end }}>
                </div>

                <div class="form-group">
                    <label for="Description">Description</label>
                    <input type="text" id="Description" name="Description" maxlength="50"{{ if not .IsNew }} value="{{ .Tournament.Description }}"{{ end }}>
                </div>

                <div class="form-group">
                    <label for="FooterPlugsID">Footer Plugs</label>
                    <select id="FooterPlugsID" name="FooterPlugsID" required>
                        {{ range .FooterSets }}
                        <option value="{{ .FooterPlugsID }}"{{ if and (not $.IsNew) (eq .FooterPlugsID $.Tournament.FooterPlugsID) }} selected{{ end }}>{{ .Name }}</option>
                        {{ end }}
                    </select>
                </div>
            </div>

            <div class="form-section">
                <h2> Chip Setup </h2>

                <div class="form-group">
                    <label title="Chips per buy-in, used for calculating total chips in play." for="ChipsPerBuyIn">Chips
                        Per Buy-In</label>
                    <input type="text" id="ChipsPerBuyIn" name="ChipsPerBuyIn" maxlength="30" pattern="[0-9,]+"{{ if not .IsNew }}
                      value="{{ .Tournament.Structure.ChipsPerBuyIn }}"{{ end }}>
                </div>

                <div class="form-group">
                    <label for="ChipsPerAddOn">Chips Per Add-On</label>
                    <input type="text" id="ChipsPerAddOn" name="ChipsPerAddOn" maxlength="30" pattern="[0-9,]+" 
                    {{ if not .IsNew }}value="{{ .Tournament.Structure.ChipsPerAddOn }}"{{ end }}>
                </div>

                <div class="form-group">
                    <label for="TotalChipsOverride">Total Chips Override</label>
                    <input type="text" id="TotalChipsOverride" name="TotalChipsOverride" maxlength="30"
                        pattern="[0-9,]+" placeholder="0 to auto-compute"{{ if not .IsNew }}
                        value="{{ .Tournament.State.TotalChipsOverride }}"{{ end }}>
                </div>
            </div>

            <div class="form-section">
                <h2> Prize Pool Calculation &amp; Display </h2>

                <div class="form-group">
                    <label title="Amount added to prize pool per buy-in (regular or re-buy)."
                    for="PrizePoolPerBuyIn">Prize Pool Per Buy-In</label>
                    <input type="text" id="PrizePoolPerBuyIn" name="PrizePoolPerBuyIn" maxlength="7" pattern="[0-9,]+"
                        {{ if not .IsNew }} value="{{ .Tournament.PrizePoolPerBuyIn }}"{{ end }}>
                </div>

                <div class="form-group">
                    <label title="Amount added to prize pool per add-on."
                    for="PrizePoolPerAddOn">Prize Pool Per Add On</label>
                    <input type="text" id="PrizePoolPerAddOn" name="PrizePoolPerAddOn" maxlength="7" pattern="[0-9,]+"
                        {{ if not .IsNew }} value="{{ .Tournament.PrizePoolPerAddOn }}"{{ end }}>
                </div>

                <div class="form-group">
                    <label 
                    title="Set this to override the automatic computation of the prize pool."
                    for="TotalPrizePoolOverride">Total Prize Pool Override</label>
                    <input type="text" id="TotalPrizePoolOverride" name="TotalPrizePoolOverride" maxlength="30"
                        pattern="[0-9,]+" placeholder="0 to auto-compute"{{ if not .IsNew }}
                        value="{{ .Tournament.State.TotalPrizePoolOverride }}"{{ end }}>
                </div>

                <div class="form-group">
                    <label for="PrizePoolMode">Prize Pool Mode</label>
                    <select id="PrizePoolMode" name="PrizePoolMode" onchange="togglePrizePoolMode()">
                        <option value="manual" {{ if not .Tournament.State.AutoComputePrizePool }}selected{{ end }}>
                            Manual Message
                        </option>
                        <option value="calculated" {{ if .Tournament.State.AutoComputePrizePool }}selected{{ end }}>
                            Calculated
                            Prize
                            Pool</option>
                    </select>
                </div>

                <div class="form-group" id="PaytableGroup"
                    style="display: {{ if .Tournament.State.AutoComputePrizePool -}} block {{- else -}} none {{- end -}};">
                    <label for="PaytableID">Paytable</label>
                    <select id="PaytableID" name="PaytableID" onchange="recalculatePrizePool()">
                        {{ range $.Paytables }}
                        <option value="{{ .ID }}" {{ if eq .ID $.Tournament.PaytableID }}selected{{ end }}>{{ .Name }}
                        </option>
                        {{ end }}
                    </select>

                    <div class="form-group">
                        <label for="Saves">Saves</label>
                        <input type="text" id="Saves" name="NumberOfSaves" maxlength="6" pattern="[0-9,]+"
                            value="{{ .Tournament.State.Saves }}">
                    </div>

                    <div class="form-group">
                        <label for="AmountPerSave">Amount per Save</label>
                        <input type="text" id="AmountPerSave" name="AmountPerSave" maxlength="30" pattern="[0-9,]+"
                            value="{{ .Tournament.State.AmountPerSave }}">
                    </div>
                </div>

                <div class="form-group">
                    <label title="Prize pool displayed on right rail of tourney view page." for="PrizePool">Prize
                        Pool</label>
                    <small id="PrizePoolHelp">{{ if and (not .IsNew) .Tournament.State.AutoComputePrizePool }}Automatically calculated
                        based on
                        buy-ins,
                        add-ons, and selected paytable{{ else }}Free-form text. No HTML tags.{{ end }}</small>
                    <textarea id="PrizePool" name="PrizePool" rows="12" cols="20" {{ if and (not .IsNew)
                        .Tournament.State.AutoComputePrizePool }}readonly{{ end
                        }}>{{ if not .IsNew }}{{ .Tournament.State.PrizePool }}{{ end }}</textarea>
                </div>
            </div>

            <div class="form-section">
                <h2> {{ if .IsNew }}Structure{{ else }}Change Structure{{ end }} </h2>
                <div class="form-group">
                    {{ if .IsNew }}
                    <input type="hidden" id="ChangeStructure" name="ChangeStructure" value="on">
                    {{ else }}
                    <p>Changing the structure will reset the tournament to level 0!</p>
                    <label>
                        <input type="checkbox" id="ChangeStructure" name="ChangeStructure"
                            onchange="toggleStructureSelect()">
                        Change Structure
                    </label>
                    {{ end }}
                    <select id="StructureID" name="StructureID" {{ if .IsNew }}required{{ else }}disabled{{ end }}>
                        {{ range $.Structures }}
                        <option value="{{ .ID }}" {{ if and (not $.IsNew) (eq .ID $.Tournament.FromStructureID) }}selected{{ end }}>{{ .Name }}
                        </option>
                        {{ end }}
                    </select>
                </div>
            </div>

            <div class="form-section">
                <h2> Tournament State </h2>
                <div> Most of this can be edited live on the tournament view page. </div>
                <div class="form-group">
                    <label for="CurrentPlayers">Current Players</label>
                    <input type="text" id="CurrentPlayers" name="CurrentPlayers" maxlength="6" pattern="[0-9,]+"
                        value="{{ .Tournament.State.CurrentPlayers }}">
                </div>

                <div class="form-group">
                    <label for="BuyIns">Buy-Ins</label>
                    <input type="text" id="BuyIns" name="BuyIns" maxlength="6" pattern="[0-9,]+"
                        value="{{ .Tournament.State.BuyIns }}">
                </div>

                <div class="form-group">
                    <label for="AddOns">Add-Ons</label>
                    <input type="text" id="AddOns" name="AddOns" maxlength="6" pattern="[0-9,]+"
                        value="{{ .Tournament.State.AddOns }}">
                </div>
            </div>

            <script>
                {{ if not .IsNew }}
                function toggleStructureSelect() {
                    const checkbox = document.getElementById('ChangeStructure');
                    const select = document.getElementById('StructureID');
                    select.disabled = !checkbox.checked;
                    if (!checkbox.checked) {
                        select.removeAttribute('required');
                    } else {
                        select.setAttribute('required', 'required');
                    }
                }
                {{ end }}

                function togglePrizePoolMode() {
                    const mode = document.getElementById('PrizePoolMode').value;
                    const paytableGroup = document.getElementById('PaytableGroup');
                    const prizePoolTextarea = document.getElementById('PrizePool');
                    const helpText = document.getElementById('PrizePoolHelp');

                    if (mode === 'calculated') {
                        paytableGroup.style.display = 'block';
                        prizePoolTextarea.readOnly = true;
                        helpText.textContent = 'Automatically calculated based on buy-ins, add-ons, and selected paytable';
                        recalculatePrizePool();
                    } else {
                        paytableGroup.style.display = 'none';
                        prizePoolTextarea.readOnly = false;
                        helpText.textContent = 'Free-form text (no HTML).';
                    }
                }

                async function recalculatePrizePool() {
                    const mode = document.getElementById('PrizePoolMode').value;
                    if (mode !== 'calculated') {
                        return;
                    }

                    // Gather parameters
                    const paytableId = parseInt(document.getElementById('PaytableID').value);
                    const buyIns = parseInt(document.getElementById('BuyIns').value) || 0;
                    const addOns = parseInt(document.getElementById('AddOns').value) || 0;
                    const saves = parseInt(document.getElementById('Saves').value) || 0;
                    const amountPerSave = parseInt(document.getElementById('AmountPerSave').value) || 0;
                    const prizePoolPerBuyIn = parseInt(document.getElementById('PrizePoolPerBuyIn').value) || 0;
                    const prizePoolPerAddOn = parseInt(document.getElementById('PrizePoolPerAddOn').value) || 0;
                    const totalPrizePoolOverride = parseInt(document.getElementById('TotalPrizePoolOverride').value) || 0;

                    if (buyIns === 0) {
                        document.getElementById('PrizePool').value = 'No buy-ins, so no prizes.';
                        return;
                    }
                    if (prizePoolPerBuyIn === 0) {
                        document.getElementById('PrizePool').value = 'No prize pool per buy-in, so no prizes.';
                        return;
                    }

                    try {
                        const response = await fetch('/api/prizePoolCalculator', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                paytableId,
                                buyIns,
                                addOns,
                                saves,
                                amountPerSave,
                                prizePoolPerBuyIn,
                                prizePoolPerAddOn,
                                totalPrizePoolOverride
                            })
                        });

                        if (!response.ok) {
                            throw new Error('Failed to calculate prize pool');
                        }

                        const data = await response.json();
                        document.getElementById('PrizePool').value = data.prizePoolText;
                    } catch (error) {
                        console.error('Error calculating prize pool:', error);
                        document.getElementById('PrizePool').value = 'Error calculating prize pool';
                    }
                }

                // Add event listeners for recalculation on field changes
                document.addEventListener('DOMContentLoaded', function () {
                    const fieldsToWatch = [
                        'BuyIns', 'AddOns', 'Saves', 'AmountPerSave',
                        'PrizePoolPerBuyIn', 'PrizePoolPerAddOn', 'TotalPrizePoolOverride'
                    ];

                    fieldsToWatch.forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        if (field) {
                            field.addEventListener('input', () => {
                                if (document.getElementById('PrizePoolMode').value === 'calculated') {
                                    recalculatePrizePool();
                                }
                            });
                        }
                    });

                    // Initialize on load if in calculated mode
                    if (document.getElementById('PrizePoolMode').value === 'calculated') {
                        recalculatePrizePool();
                    }
                });
            </script>

            <div class="actions">
                {{ if not .IsAdmin }}
                <p>You can look but you can't touch</p>
                {{ else if .IsNew }}
                <button type="submit">Create Tournament</button>
                <button type="reset">Reset</button>
                {{ else }}
                <button type="submit">Save Changes</button>
                <button type="reset">Reset to Saved Values</button>
                {{ end }}
            </div>

        </form>

        {{ if .Flash }}<div class="flash">{{ .Flash }}</div>{{ end }}
    </div>
</body>

</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>{{ if .IsNew }}Create{{ else }}Edit{{ end }} Structure</title>
    <link rel="stylesheet" href="/fs/irata-style.css">
</head>
<body>

<script>
  function getLevelNumber(banner) {
    const match = banner.match(/(\d+)$/);
    return match ? parseInt(match[1], 10) : null;
  }

  function createLevelRowHTML(idx, duration = '', banner = '', description = '', isBreak = false) {
    return `
      <input type="number" name="Level${idx}Duration" min="1" required 
             placeholder="Minutes" value="${duration}" class="level-duration-input">
      <input type="text" name="Level${idx}Banner" required 
             placeholder="Banner Text" value="${banner}" class="level-banner-input">
      <input type="text" name="Level${idx}Description" required 
             placeholder="Description" value="${description}" class="level-description-input">
      <label class="level-break-label">
        <input type="checkbox" name="Level${idx}IsBreak" id="Level${idx}IsBreak" 
               ${isBreak ? 'checked' : ''} onchange="onBreakToggle(this)">Break
      </label>
      <button type="button" class="delete-btn" onclick="tryDelete(this)">&#x274c;</button>
    `;
  }

  function updateBannerNumber(banner, newNumber) {
    const match = banner.match(/^(\D*[Ll][Ee][Vv][Ee][Ll].*\D)?(\d+)$/);
    if (match) {
      const prefix = match[1] || '';
      return prefix + newNumber;
    }
    return banner;
  }

  function renumberLevels() {
    const levelsDiv = document.getElementById('levels');
    const rows = levelsDiv.children;
    let levelCounter = 1;
   
    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      const isBreakCheckbox = row.querySelector('input[type="checkbox"]');
      const bannerInput = row.querySelector('input[name^="Level"][name$="Banner"]');
      
      if (!isBreakCheckbox || !bannerInput) {
        console.log('Row', i, 'missing checkbox or banner input');
        continue;
      }
      
      const isBreak = isBreakCheckbox.checked;
      console.log('Row', i, 'isBreak:', isBreak, 'banner:', bannerInput.value);
      
      if (isBreak) {
        const currentBanner = bannerInput.value;
        if (/^LEVEL\s+\d+$/i.test(currentBanner)) {
          bannerInput.value = 'BREAK';
        }
      } else {
        // Only renumber non-break levels
        const currentBanner = bannerInput.value;
        
        if (/^BREAK$/i.test(currentBanner)) {
          bannerInput.value = 'LEVEL ' + levelCounter;
        } else {
          const currentNumber = getLevelNumber(currentBanner);
                   
          // If banner has a number, update it to match the current level counter
          if (currentNumber !== null) {
            const newBanner = updateBannerNumber(currentBanner, levelCounter);
            if (newBanner !== currentBanner) {
              bannerInput.value = newBanner;
            }
          }
        }
        levelCounter++;
      }
    }
  }

  function onBreakToggle(checkbox) {
    renumberLevels();
  }

  function setAllLevelDurations() {
    const newDuration = prompt('Enter new duration (in minutes) for all levels:');
    if (newDuration === null || newDuration.trim() === '') {
      return; // User cancelled or entered nothing
    }
    
    const duration = parseInt(newDuration, 10);
    if (isNaN(duration) || duration <= 0) {
      alert('Please enter a valid positive number');
      return;
    }
    
    const levelsDiv = document.getElementById('levels');
    const rows = levelsDiv.children;
    
    for (let i = 0; i < rows.length; i++) {
      let isBreak = document.getElementById(`Level${i}IsBreak`)
      if (isBreak?.checked) {
        continue;
      } else {
        console.log(`Level${i}Isbreak ${isBreak} ... ${isBreak?.checked}`);
      }
      const row = rows[i];
      const durationInput = row.querySelector('input[type="number"]');
      if (durationInput) {
        durationInput.value = duration;
      }
    }
  }

  function tryDelete(button) {
    const levelsDiv = document.getElementById('levels');
    if (levelsDiv.children.length <= 2) {
      alert('A structure must have at least two levels');
      return;
    }
    button.parentNode.remove();
  }

  function addLevel() {
    const levelsDiv = document.getElementById('levels');
    const idx = levelsDiv.children.length;
    let prevDuration = "";
    let nextBanner = "";
    
    if (idx > 0) {
      const prevRow = levelsDiv.children[idx - 1];
      const prevInput = prevRow.querySelector('input[type="number"]');
      const prevBanner = prevRow.querySelector('input[name^="Level"][name$="Banner"]').value;
      
      if (prevInput) {
        prevDuration = prevInput.value;
      }

      const prevLevelNum = getLevelNumber(prevBanner);
      if (prevLevelNum !== null) {
        nextBanner = prevBanner.replace(prevLevelNum.toString(), (prevLevelNum + 1).toString());
      }
    }
    
    const row = document.createElement('div');
    row.className = 'level-row';
    row.innerHTML = createLevelRowHTML(idx, prevDuration, nextBanner, '', false);
    levelsDiv.appendChild(row);
  }
</script>

<script id="level-data" type="application/json">
{{ if .Structure.Levels }}
  {{ range $i, $lvl := .Structure.Levels }}
    {{ if $i }},{{ end }}
    {"idx": {{ $i }}, "duration": {{ $lvl.DurationMinutes }}, "banner": {{ $lvl.Banner | js }}, "description": {{ $lvl.Description | js }}, "isBreak": {{ $lvl.IsBreak }}}
  {{ end }}
{{ else }}
  {"idx": 0, "duration": 15, "banner": "TOURNAMENT STARTING", "description": "PLEASE TAKE YOUR SEATS", "isBreak": false},
  {"idx": 1, "duration": 20, "banner": "LEVEL 1", "description": "BLINDS 25-50 + 50", "isBreak": false}
{{ end }}
</script>

<script>
  // Render all levels from data on page load
  window.addEventListener('DOMContentLoaded', function() {
    const levelsDiv = document.getElementById('levels');
    const dataElement = document.getElementById('level-data');
    const levelData = JSON.parse('[' + dataElement.textContent.trim() + ']');
    
    levelData.forEach(level => {
      const row = document.createElement('div');
      row.className = 'level-row';
      row.innerHTML = createLevelRowHTML(level.idx, level.duration, level.banner, level.description, level.isBreak);
      levelsDiv.appendChild(row);
    });
  });
</script>

    <div class="container">
        {{ if .Flash }}<div class="flash">{{ .Flash }}</div>{{ end }}
        <div class="admin-bar">
            <a href="/manage/structure">&lt; Back to Structures</a>
            {{ if not .IsNew }}
            <a href="/create/structure?template={{ .Structure.ID }}">Copy This Structure</a>
            {{ end }}
        </div>

        <h1>{{ if .IsNew }}Create{{ else }}Edit{{ end }} Structure {{ if not .IsNew }}{{ .Structure.ID }}{{ end }} </h1>

        <form method="POST">
            <div class="form-group">
                <label for="Name">Structure Name</label>
                <input type="text" id="Name" name="Name" autocomplete="off" value="{{ .Structure.Name }}" required>
            </div>
            
            <div class="actions">
                <button type="submit">Save</button>
                <a href="/manage/structure">Cancel</a>
                <button type="button" id="add-level-btn" onclick="addLevel()">Add Level</button>
                <button type="button" onclick="setAllLevelDurations()">Set Level Durations</button>
            </div>

            <div id="levels">
                <!-- Levels will be rendered by JavaScript -->
            </div>
            
            <div class="actions">
                <button type="submit">Save</button>
                <a href="/manage/structure">Cancel</a>
                <button type="button" id="add-level-btn" onclick="addLevel()">Add Level</button>
                <button type="button" onclick="setAllLevelDurations()">Set Level Durations</button>
            </div>
            
            {{ if .Flash }}<div class="flash">{{ .Flash }}</div>{{ end }}
        </form>
    </div>
</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>{{ if .IsNew }}Create{{ else }}Edit{{ end }} Structure</title>
    <link rel="stylesheet" href="/fs/{{ .Theme }}-style.css">
</head>
<body>
{{ template "user-bar" . }}

<script>
  function getLevelNumber(banner) {
    const match = banner.match(/(\d+)$/);
    return match ? parseInt(match[1], 10) : null;
  }

  function createLevelRowHTML(idx, level) {
    const duration = level.DurationMinutes || '1';
    const banner = level.Banner || '';
    const description = level.Description || '';
    const isBreak = level.IsBreak || false;
    const autoPause = level.AutoPause || idx === 0 || false;

    const autoPauseLabelText = autoPause ? '&#x23f8;' : '&#x23f5;';
    const isBreakLabelText = isBreak ? 'Break' : 'Level';
    const aptitle = (idx===0? 'First level always starts paused.' : 'Run (default) or Auto-Pause at the start of this level.');
    return `
      <label title="${aptitle}"
      id="Level${idx}AutoPauseLabel" class="level-${autoPause?'autopause':'run'}"><input class="level-autopause-cb" type="checkbox" style="display:none;" name="Level${idx}AutoPause" id="Level${idx}AutoPause" 
               ${autoPause ? 'checked' : ''} ${idx===0? '' : 'onchange="onAutoPauseToggle(this)'}">${autoPauseLabelText}</label>
      <input type="number" name="Level${idx}Duration" min="1" required 
             title="Duration in minutes"
             placeholder="Minutes" value="${duration}" class="level-duration-input">
      <input type="text" name="Level${idx}Banner" required 
             title="Banner text appears above the clock"
             placeholder="Banner Text" value="${banner}" class="level-banner-input">
      <input type="text" name="Level${idx}Description" required 
             title="Description of level (blinds) appears under the clock"
             placeholder="Description" value="${description}" class="level-description-input">
      <label
       title="Mark this level as a break."
       id="Level${idx}IsBreakLabel" class="level-${isBreak?'break':'level'}"><input class="level-break-cb" type="checkbox" style="display:none;" name="Level${idx}IsBreak" id="Level${idx}IsBreak" 
               ${isBreak ? 'checked' : ''} onchange="onBreakToggle(this)">${isBreakLabelText}</label>
      <button title="Delete this level" type="button" class="delete-btn" onclick="tryDelete(this)">&#x274c;</button>
    `;
  }

  function updateBannerNumber(banner, newNumber) {
    const match = banner.match(/^(\D*[Ll][Ee][Vv][Ee][Ll].*\D)?(\d+)$/);
    if (match) {
      const prefix = match[1] || '';
      return prefix + newNumber;
    }
    return banner;
  }

  function renumberLevels() {
    const levelsDiv = document.getElementById('levels');
    const rows = levelsDiv.children;
    let levelCounter = 1;
   
    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      const isBreakCheckbox = row.querySelector('input[name^="Level"][name$="IsBreak"]');
      const bannerInput = row.querySelector('input[name^="Level"][name$="Banner"]');
      
      if (!isBreakCheckbox || !bannerInput) {
        console.log('Row', i, 'missing checkbox or banner input');
        continue;
      }
      
      const isBreak = isBreakCheckbox.checked;
      console.log('Row', i, 'isBreak:', isBreak, 'banner:', bannerInput.value);
      
      if (isBreak) {
        const currentBanner = bannerInput.value;
        if (/^LEVEL\s+\d+$/i.test(currentBanner)) {
          bannerInput.value = 'BREAK';
        }
      } else {
        // Only renumber non-break levels
        const currentBanner = bannerInput.value;
        
        if (/^BREAK$/i.test(currentBanner)) {
          bannerInput.value = 'LEVEL ' + levelCounter;
        } else {
          const currentNumber = getLevelNumber(currentBanner);
                   
          // If banner has a number, update it to match the current level counter
          if (currentNumber !== null) {
            const newBanner = updateBannerNumber(currentBanner, levelCounter);
            if (newBanner !== currentBanner) {
              bannerInput.value = newBanner;
            }
          }
        }
        levelCounter++;
      }
    }
  }

  function onAutoPauseToggle(checkbox) {
    // Update the label class and text based on checkbox state
    const label = checkbox.parentElement;
    if (checkbox.checked) {
      label.classList.remove('level-run');
      label.classList.add('level-autopause');
      // Update just the text node, preserving the checkbox
      const textNode = Array.from(label.childNodes).find(node => node.nodeType === Node.TEXT_NODE);
      if (textNode) textNode.textContent = '⏸';

    } else {
      label.classList.remove('level-level-autopause');
      label.classList.add('level-run');
      // Update just the text node, preserving the checkbox
      const textNode = Array.from(label.childNodes).find(node => node.nodeType === Node.TEXT_NODE);
      if (textNode) textNode.textContent = '⏵';
    }
    renumberLevels();
  }

  function onBreakToggle(checkbox) {
    // Update the label class and text based on checkbox state
    const label = checkbox.parentElement;
    if (checkbox.checked) {
      label.classList.remove('level-level');
      label.classList.add('level-break');
      // Update just the text node, preserving the checkbox
      const textNode = Array.from(label.childNodes).find(node => node.nodeType === Node.TEXT_NODE);
      if (textNode) textNode.textContent = 'Break';
    } else {
      label.classList.remove('level-break');
      label.classList.add('level-level');
      // Update just the text node, preserving the checkbox
      const textNode = Array.from(label.childNodes).find(node => node.nodeType === Node.TEXT_NODE);
      if (textNode) textNode.textContent = 'Level';
    }
    renumberLevels();
  }

  function setAllLevelDurations() {
    const newDuration = prompt('Enter new duration (in minutes) for all levels:');
    if (newDuration === null || newDuration.trim() === '') {
      return; // User cancelled or entered nothing
    }
    
    const duration = parseInt(newDuration, 10);
    if (isNaN(duration) || duration <= 0) {
      alert('Please enter a valid positive number');
      return;
    }
    
    const levelsDiv = document.getElementById('levels');
    const rows = levelsDiv.children;
    
    for (let i = 0; i < rows.length; i++) {
      let isBreak = document.getElementById(`Level${i}IsBreak`)
      if (isBreak?.checked) {
        continue;
      } else {
        console.log(`Level${i}Isbreak ${isBreak} ... ${isBreak?.checked}`);
      }
      const row = rows[i];
      const durationInput = row.querySelector('input[type="number"]');
      if (durationInput) {
        durationInput.value = duration;
      }
    }
  }

  function tryDelete(button) {
    const levelsDiv = document.getElementById('levels');
    if (levelsDiv.children.length <= 2) {
      alert('A structure must have at least two levels');
      return;
    }
    button.parentNode.remove();
  }

  function addLevel() {
    const levelsDiv = document.getElementById('levels');
    const idx = levelsDiv.children.length;
    let prevDuration = "";
    let nextBanner = "";
    
    if (idx > 0) {
      const prevRow = levelsDiv.children[idx - 1];
      const prevInput = prevRow.querySelector('input[type="number"]');
      const prevBanner = prevRow.querySelector('input[name^="Level"][name$="Banner"]').value;
      
      if (prevInput) {
        prevDuration = prevInput.value;
      }

      const prevLevelNum = getLevelNumber(prevBanner);
      if (prevLevelNum !== null) {
        nextBanner = prevBanner.replace(prevLevelNum.toString(), (prevLevelNum + 1).toString());
      }
    }
    
    const row = document.createElement('div');
    row.className = 'level-row';
    row.innerHTML = createLevelRowHTML(idx, {
      DurationMinutes: prevDuration,
      Banner: nextBanner,
      Description: '',
      IsBreak: false,
      AutoPause: false
    });
    levelsDiv.appendChild(row);
  }
</script>

<script>
  // Render all levels from data on page load
  window.addEventListener('DOMContentLoaded', function() {
    const levelsDiv = document.getElementById('levels');
    let levelData = {{ .LevelsJSON }};
    
    // Ensure levelData is always an array
    if (!levelData || !Array.isArray(levelData)) {
      console.log('levelData is not an array, resetting to []');
      levelData = [];
    }
    
    // If no levels exist, add default levels for new structures
    if (levelData.length === 0) {
      levelData = [
        {Banner: "WELCOME", Description: "PLEASE TAKE YOUR SEATS", DurationMinutes: 15, IsBreak: true},
        {Banner: "LEVEL 1", Description: "BLINDS 25-50 + 50", DurationMinutes: 20, IsBreak: false}
      ];
    }
    
    levelData.forEach((level, idx) => {
      const row = document.createElement('div');
      row.className = 'level-row';
      row.innerHTML = createLevelRowHTML(idx, level);
      levelsDiv.appendChild(row);
    });
  });
</script>

    <div class="container">
        {{ if .Flash }}<div class="flash">{{ .Flash }}</div>{{ end }}
        <div class="admin-bar">
            <a href="/manage/structure">&lt; Back to Structures</a>
            {{ if not .IsNew }}
            <a href="/create/structure?template={{ .Structure.ID }}">Copy This Structure</a>
            {{ end }}
        </div>

        <h1>{{ if .IsNew }}Create{{ else }}Edit{{ end }} Structure {{ if not .IsNew }}{{ .Structure.ID }}{{ end }} </h1>

        <form method="POST">
            <div class="form-group">
                <label for="Name">Structure Name</label>
                <input type="text" id="Name" name="Name" autocomplete="off" value="{{ .Structure.Name }}" required>
            </div>

            <div class="form-group">
                <label for="ChipsPerBuyIn">Chips Per Buy-In</label>
                <input type="number" id="ChipsPerBuyIn" name="ChipsPerBuyIn" min="0" value="{{ .Structure.ChipsPerBuyIn }}" class="field-large">
                <small>Starting chips each player receives per buy-in</small>
            </div>

            <div class="form-group">
                <label for="ChipsPerAddOn">Chips Per Add-On</label>
                <input type="number" id="ChipsPerAddOn" name="ChipsPerAddOn" min="0" value="{{ .Structure.ChipsPerAddOn }}" class="field-large">
                <small>Additional chips players receive per add-on (leave 0 if no add-ons)</small>
            </div>
            
            <div class="actions">
                <button type="submit">Save</button>
                <a href="/manage/structure">Cancel</a>
                <button type="button" id="add-level-btn" onclick="addLevel()">Add Level</button>
                <button type="button" onclick="setAllLevelDurations()">Set Level Durations</button>
            </div>

            <div id="levels">
                <!-- Levels will be rendered by JavaScript -->
            </div>
            
            <div class="actions">
                <button type="submit">Save</button>
                <a href="/manage/structure">Cancel</a>
                <button type="button" id="add-level-btn" onclick="addLevel()">Add Level</button>
                <button type="button" onclick="setAllLevelDurations()">Set Level Durations</button>
            </div>
            
            {{ if .Flash }}<div class="flash">{{ .Flash }}</div>{{ end }}
        </form>
    </div>
</body>
</html>

